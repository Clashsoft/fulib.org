<div class="container">
  <h1>Create Assignment</h1>

  <div class="form-inline">
    <div class="input-group mb-2 mr-sm-2">
      <div class="custom-file">
        <input type="file" class="custom-file-input" id="importFile" aria-describedby="importFileLabel"
               (change)="importFile = $event.target.files[0]">
        <label class="custom-file-label" for="importFile" id="importFileLabel">
          {{importFile ? importFile.name : 'Choose file'}}
        </label>
      </div>
      <div class="input-group-append">
        <button type="button" class="btn btn-primary" (click)="onImport()">Import</button>
      </div>
    </div>
    <button type="button" class="btn btn-primary mb-2 mr-sm-2" (click)="onExport()">Export</button>
  </div>

  <h2>General Info</h2>

  <div class="form">
    <div class="form-group row">
      <label for="titleInput" class="col-sm-2 col-form-label">Title</label>
      <div class="col-sm-10">
        <input type="text" class="form-control" id="titleInput" placeholder="Assignment X"
               [(ngModel)]="title" (change)="saveDraft()">
      </div>
    </div>
    <div class="form-group row">
      <label for="authorInput" class="col-sm-2 col-form-label">Your Name</label>
      <div class="col-sm-10">
        <input type="text" class="form-control" id="authorInput" placeholder="John Doe"
               [(ngModel)]="author" (change)="saveDraft()">
      </div>
    </div>
    <div class="form-group row">
      <label for="emailInput" class="col-sm-2 col-form-label">Your E-Mail</label>
      <div class="col-sm-10">
        <input type="text" class="form-control" id="emailInput" placeholder="jdoe@example.com"
               [(ngModel)]="email" (change)="saveDraft()">
      </div>
    </div>
    <div class="form-group row">
      <label for="deadlineDateInput" class="col-sm-2 col-form-label">Deadline</label>
      <div class="col-sm-3">
        <input type="date" class="form-control" id="deadlineDateInput"
               [(ngModel)]="deadlineDate" useValueAsDate (change)="saveDraft()">
      </div>
      <label for="deadlineTimeInput" class="sr-only">Time</label>
      <div class="col-sm-2">
        <input type="time" class="form-control" id="deadlineTimeInput"
               [(ngModel)]="deadlineTime" useValueAsDate (change)="saveDraft()">
      </div>
    </div>
  </div>

  <h2><label for="descriptionInput">Description</label></h2>

  <p>
    <textarea id="descriptionInput" class="form-control" rows="6" [(ngModel)]="description"
              (change)="saveDraft()"></textarea>
    <small class="text-muted">
      <a href="https://commonmark.org/help/">Markdown syntax</a> is supported.
    </small>
  </p>

  <h2>
    <label for="solutionInput">Sample Solution</label>
    <app-collapse-button class="ml-2" [(collapsed)]="collapse.solution"></app-collapse-button>
  </h2>
  <p [ngbCollapse]="collapse.solution">
    <app-autotheme-codemirror id="solutionInput" [(content)]="solution" (change)="saveDraft()" [options]="{
      mode: 'markdown',
      lineNumbers: true,
      lineWrapping: true,
      styleActiveLine: true
    }"></app-autotheme-codemirror>
    <small class="text-muted">
      You can provide a sample solution to ensure your assignment is solvable.
      Students cannot see this.
    </small>
  </p>

  <h2>
    <label for="templateSolutionInput">Template Solution</label>
    <app-collapse-button class="ml-2" [(collapsed)]="collapse.templateSolution"></app-collapse-button>
  </h2>
  <p [ngbCollapse]="collapse.templateSolution">
    <app-autotheme-codemirror id="templateSolutionInput" [(content)]="templateSolution" (change)="saveDraft()" [options]="{
      mode: 'markdown',
      lineNumbers: true,
      lineWrapping: true,
      styleActiveLine: true
    }"></app-autotheme-codemirror>
    <small class="text-muted">
      Optional. This will be shown to students in the solution editor when they first open your assignment.
      You can instruct them to fill in blanks or make changes.
    </small>
  </p>

  <h2>Tasks</h2>
  <ol dragula="TASKS" [(dragulaModel)]="tasks" (dragulaModelChange)="saveDraft()">
    <li *ngFor="let task of tasks; let id = index">
      <div class="d-flex align-items-center mb-2">
        <div class="mr-2">
          {{task.description || '(no description)'}}
          <span class="badge badge-secondary">{{task.points === 0 || task.points > 0 ? task.points : '?'}}</span>
        </div>
        <app-collapse-button class="ml-auto" [(collapsed)]="task.collapsed" (collapsedChange)="saveDraft()">
        </app-collapse-button>
        <div class="btn btn-secondary ml-2 handle" aria-label="Reorder">
          <span class="handle" aria-hidden="true">&equiv;</span>
        </div>
        <button type="button" class="btn btn-danger ml-2" (click)="removeTask(id)" aria-label="Remove">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="form mb-3" [ngbCollapse]="task.collapsed">
        <div class="form-group row">
          <label for="task/{{id}}/descriptionInput" class="col-sm-2 col-form-label">Description</label>
          <div class="col-sm-10">
            <input type="text" class="form-control" id="task/{{id}}/descriptionInput"
                   [(ngModel)]="task.description" (change)="saveDraft()">
          </div>
        </div>
        <div class="form-group row">
          <label for="task/{{id}}/pointsInput" class="col-sm-2 col-form-label">Points</label>
          <div class="col-sm-10">
            <input type="number" class="form-control" id="task/{{id}}/pointsInput" min="0"
                   [(ngModel)]="task.points" (change)="saveDraft()">
          </div>
        </div>
        <div class="form-group row">
          <label for="task/{{id}}/verificationInput" class="col-sm-2 col-form-label">Verification</label>
          <div class="col-sm-10">
            <app-autotheme-codemirror id="task/{{id}}/verificationInput"
                                      [(content)]="task.verification"
                                      (change)="saveDraft()"
                                      [options]="{
              mode: 'markdown',
              lineNumbers: true,
              lineWrapping: true,
              styleActiveLine: true
            }"></app-autotheme-codemirror>
          </div>
        </div>
      </div>
    </li>
  </ol>
  <p>
    <button type="button" class="btn btn-success" (click)="addTask()">Add Task</button>
    <button type="button" class="btn btn-danger" (click)="clearTasks()">Remove All Tasks</button>
  </p>

  <div class="text-center">
    <p>
      Click "Submit" to finalize your assignment and generate a link.
    </p>
    <button type="button" class="btn btn-primary btn-lg" id="submitButton" (click)="submit()"
            [disabled]="submitting">
      {{submitting ? 'Submitting...' : 'Submit'}}
    </button>
  </div>
</div>

<!-- Modal -->
<ng-template #successModal let-modal>
  <div class="modal-header">
    <h5 class="modal-title" id="successModalLabel">Assignment Created</h5>
    <button type="button" class="close" aria-label="Close" (click)="modal.close()">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <p>
      Congratulations! Your assignment titled <b>{{title}}</b> has been created!
    </p>
    <p>
      You can now give your students the following link:
    </p>
    <p>
      <a class="text-monospace" href="/assignments/{{id}}">
        {{baseURL}}/assignments/{{id}}
      </a>
      <button id="copyAssignmentLinkButton" type="button" class="btn btn-sm btn-outline-primary"
              ngxClipboard *ngxClipboardIfSupported cbContent="{{baseURL}}/assignments/{{id}}">
        Copy
      </button>
    </p>
    <p>
      Use this link to view submitted solutions:
    </p>
    <p>
      <a class="text-monospace" href="/assignments/{{id}}/solutions">
        {{baseURL}}/assignments/{{id}}/solutions
      </a>
      <button id="copySolutionsLinkButton" type="button" class="btn btn-sm btn-outline-primary"
              ngxClipboard *ngxClipboardIfSupported cbContent="{{baseURL}}/assignments/{{id}}/solutions">
        Copy
      </button>
    </p>
    <p>
      To view submissions, you may be asked for the following token.
      Please save it or note it down somewhere.
    </p>
    <p class="text-center">
      <span class="h4 text-monospace">{{token}}</span>
      <button id="copyTokenButton" type="button" class="btn btn-sm btn-outline-secondary"
              ngxClipboard *ngxClipboardIfSupported [cbContent]="token">
        Copy
      </button>
    </p>
    <p>
      Note that this assignment can no longer be edited.
      If you want to make changes, submit a new assignment and give your students the new link.
    </p>
  </div>
  <div class="modal-footer">
    <button type="button" class="btn btn-secondary" (click)="modal.close()">Close</button>
  </div>
</ng-template>
