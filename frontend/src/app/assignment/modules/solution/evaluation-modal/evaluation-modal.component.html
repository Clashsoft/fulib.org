<app-modal #modal size="lg" [back]="['../..']" [backOptions]="{relativeTo: route}">
  <ng-container modal-header>
    Evaluation
    <span class="text-muted">
      {{ task?.description }}
    </span>
  </ng-container>
  <ng-container modal-body>
    <div class="form">
      <div class="row">
        <div class="col-md-8" *ngIf="dto.snippets.length">
          <div class="form-group">
            <div class="alert alert-info" id="codeSearchOrigin" *ngIf="originEvaluation && originSolution">
              This evaluation was initially created by Code Search based on the original
              <a [routerLink]="['../../..', originSolution._id, 'tasks', originEvaluation.task]">
                Evaluation by {{ originEvaluation.author }}
              </a>
              for the
              <a [routerLink]="['../../..', originSolution._id]">
                Solution by {{ originSolution.author.name || originSolution.author.github }}
              </a>
              .
            </div>
            <label for="snippets">
              Snippets
            </label>
            <ul class="list-group" id="snippets">
              <li *ngFor="let snippet of dto.snippets; let index=index" class="list-group-item" [class.list-group-item-warning]="snippet.comment === selectionComment">
                <app-edit-snippet
                  [snippet]="snippet" [index]="index" [comments]="comments"
                  (deleted)="deleteSnippet(index)"
                ></app-edit-snippet>
              </li>
            </ul>
            <div class="form-text text-muted">
              Use
              <a href="https://marketplace.visualstudio.com/items?itemName=fulib.fulibFeedback" target="_blank">
                fulibFeedback
              </a>
              to add code snippets from within your IDE.
              <span *ngIf="task && task.glob" class="text-info">
                Code Search will only look for files matching the glob pattern <code>{{ task.glob }}</code>.
              </span>
            </div>
          </div>
        </div>
        <div class="col" [class.col-md-4]="dto.snippets.length">
          <div class="form-group">
            <label for="pointsInput">Points</label>
            <div class="input-group">
              <input type="number" class="form-control" id="pointsInput" [min]="min ?? ''" [max]="max ?? ''"
                     [(ngModel)]="dto.points">
              <div class="input-group-append">
                <button class="btn btn-outline-secondary text-danger" ngbTooltip="Keyboard Shortcut: Ctrl--"
                        (click)="setPoints(min)">
                  {{ min }}
                </button>
                <button class="btn btn-outline-secondary text-success" ngbTooltip="Keyboard Shortcut: Ctrl-+"
                        (click)="setPoints(max)">
                  {{ max }}
                </button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="remarkInput">Remark</label>
            <div class="input-group" *ngIf="!multilineRemark">
              <input
                type="text" class="form-control" id="remarkInput"
                ngbAutofocus
                [ngbTypeahead]="remarkTypeahead"
                (focus)="remarkFocus$.next('')"
                (click)="remarkFocus$.next('')"
                [(ngModel)]="dto.remark"
              >
              <div class="input-group-append">
                <button type="button" class="btn btn-outline-secondary" (click)="multilineRemark = 3">
                  +
                </button>
              </div>
            </div>
            <textarea
              *ngIf="multilineRemark"
              class="form-control" id="remarkInput"
              ngbAutofocus
              [(ngModel)]="dto.remark"
              [rows]="multilineRemark"
            ></textarea>
            <small class="form-text text-muted">
              <a href="https://commonmark.org/help/">Markdown Syntax</a> is supported.
            </small>
          </div>
          <div class="form-group">
            <label for="nameInput">Name</label>
            <input type="text" class="form-control" id="nameInput" [(ngModel)]="dto.author" (change)="saveDraft()"
                   [disabled]="loggedIn">
          </div>
        </div>
      </div>
    </div>
    <div class="alert alert-info" *ngIf="!dto.snippets.length">
      <span class="badge badge-primary">New</span>
      <a href="https://marketplace.visualstudio.com/items?itemName=fulib.fulibFeedback" target="_blank">
        fulibFeedback
      </a>
      can be used to add code snippets from within your IDE.
      If Code Search is enabled,
      it will automatically look for similar code in other solutions and transfer your evaluation,
      allowing you to grade multiple students at once.
    </div>
    <app-pro-tip [tips]="[
      'Press Ctrl-Enter to quickly submit your evaluation',
      'Press Ctrl-0 to give zero points',
    ]"></app-pro-tip>
  </ng-container>
  <ng-container modal-footer>
    <div class="form-check">
      <input type="checkbox" class="form-check-input" id="codeSearchCheck" [(ngModel)]="dto.codeSearch">
      <label for="codeSearchCheck" class="form-check-label" ngbTooltip="Use Code Search to create or update derived evaluations in other solutions">
        Code Search
      </label>
    </div>
    <button type="button" class="btn btn-secondary" (click)="modal.close()">
      Cancel
    </button>
    <button *ngIf="evaluation" class="btn btn-danger" (click)="delete() && modal.close()">
      Delete
    </button>
    <button type="button" class="btn btn-primary" ngbTooltip="Keyboard Shortcut: Ctrl+&#9166;"
            (click)="doSubmit(); modal.close()">
      Submit
    </button>
  </ng-container>
</app-modal>
